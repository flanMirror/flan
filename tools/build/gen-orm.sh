#!/bin/sh

DB_DIR="build/postgres/db"
SOCK_DIR_ABS="$PWD/build/postgres/sock"
PORT=3002

alias pg_ctl="pg_ctl -D $DB_DIR -o \"-k $SOCK_DIR_ABS -p $PORT\""
alias psql="psql -h $SOCK_DIR_ABS -p $PORT -U $(whoami)"

# fail if database setup or startup goes bonkers
set -e

# initialise database directory and create socket directory
mkdir -p $DB_DIR
initdb $DB_DIR
mkdir $SOCK_DIR_ABS

# start database
pg_ctl start

# database already up, the script MUST continue
set +e

# import empty db generated by upstream misskey database migration
psql postgres -c "create user misskey;"
psql postgres -c "create database misskey;"
psql misskey < $PWD/spec/misskey.sql

# ensure sqlboiler and database driver
go install github.com/volatiletech/sqlboiler/v4@latest
go install github.com/volatiletech/sqlboiler/v4/drivers/sqlboiler-psql@latest

# run code generator
env PATH=$PATH:$(go env GOPATH)/bin PSQL_HOST=$SOCK_DIR_ABS $(go env GOPATH)/bin/sqlboiler -c sqlboiler.toml psql

# run tests
psql postgres -c "alter user misskey with superuser;"
env PSQL_HOST=$SOCK_DIR_ABS go test $PWD/db/orm

# stop database and clean up
pg_ctl stop
rm -rf build/postgres
